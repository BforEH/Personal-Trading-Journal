{% extends "base.html" %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='user_detail.css') }}">
{% endblock %}

{% block title %}Trade Detail - STS{% endblock %}

{% block content %}
<h1>Trade detail</h1>
<div class="detail-wrapper">
    <!-- Left side: Reason and Feedback -->
    <div class="detail-left">
        <form method="post" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="reason-feedback-row">
                <div class="reason-col">
                    <label for="reason">Reason:</label>
                    <textarea name="reason" id="reason" rows="6">{{ user.reason or '' }}</textarea>
                    {% if user.reason_image %}
                    <div class="image-container">
                        <div class="image-wrapper">
                            <img src="{{ url_for('static', filename='uploads/' ~ user.reason_image) }}" alt="Reason Image" class="detail-image">
                            <button type="button" class="delete-image-btn" onclick="deleteImage('reason')" title="Delete image">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    <label for="reason_image">Upload New Reason Image:</label>
                    <input type="file" name="reason_image" id="reason_image" accept="image/png, image/jpeg, image/jpg">
                    <input type="hidden" name="delete_reason_image" id="delete_reason_image" value="">
                </div>
                <div class="feedback-col">
                    <label for="feedback">Feedback:</label>
                    <textarea name="feedback" id="feedback" rows="6">{{ user.feedback or '' }}</textarea>
                    {% if user.feedback_image %}
                    <div class="image-container">
                        <div class="image-wrapper">
                            <img src="{{ url_for('static', filename='uploads/' ~ user.feedback_image) }}" alt="Feedback Image" class="detail-image">
                            <button type="button" class="delete-image-btn" onclick="deleteImage('feedback')" title="Delete image">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"></polyline>
                                    <path d="m19,6v14a2,2 0 0,1 -2,2H7a2,2 0 0,1 -2,-2V6m3,0V4a2,2 0 0,1 2,-2h4a2,2 0 0,1 2,2v2"></path>
                                    <line x1="10" y1="11" x2="10" y2="17"></line>
                                    <line x1="14" y1="11" x2="14" y2="17"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    {% endif %}
                    <label for="feedback_image">Upload New Feedback Image:</label>
                    <input type="file" name="feedback_image" id="feedback_image" accept="image/png, image/jpeg, image/jpg">
                    <input type="hidden" name="delete_feedback_image" id="delete_feedback_image" value="">
                </div>
            </div>
            <button type="submit" class="btn-submit">Save Changes</button>
        </form>
    </div>

    <!-- Right side: Trade details table -->
    <div class="detail-right">
        <table class="vertical-table">
            <tbody>
                <tr><th>ID</th><td>{{ user.id }}</td></tr>
                <tr><th>Symbol</th><td>{{ user.symbol }}</td></tr>
                <tr><th>Open Time</th><td>{{ user.open_time }}</td></tr>
                <tr><th>Close Time</th><td>{{ user.close_time if user.close_time else ''}}</td></tr>
                <tr><th>Type</th><td>{{ user.type if user.type else '' }}</td></tr>
                <tr><th>Status</th><td>{{ user.status }}</td></tr>
                <tr><th>Sort</th><td>{{ user.sort }}</td></tr>
                <tr><th>Open Price</th><td>${{ user.open_price|smart_price }}</td></tr>
                <tr><th>Close Price</th><td>${{ user.close_price|smart_price }}</td></tr>
                <tr><th>Risk</th><td>{{ user.risk }}</td></tr>
                <tr><th>Stop-Loss</th><td>{% if user.SL is not none %}${{ user.SL|smart_price }}{% endif %}</td></tr>
                <tr><th>Take-Profit</th><td>{% if user.TP is not none %}${{ user.TP|smart_price }}{% endif %}</td></tr>
                <tr>
                    <th>RR</th>
                    <td class="{% if user.RR is not none and user.RR >= 0 %}pnl-positive{% elif user.RR is not none %}pnl-negative{% endif %}">
                        {{ "%.2f"|format(user.RR) if user.RR is not none else '' }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="imageModal" class="image-modal">
    <div class="modal-content">
        <span class="close-modal">&times;</span>
        <img id="modalImage" class="modal-image" src="" alt="Full Size Image">
    </div>
</div>

<a href="{{ url_for('index') }}" class="back-link">‚Üê Back to Home</a>

<script>

document.addEventListener('DOMContentLoaded', function() {
    const imageWrappers = document.querySelectorAll('.image-wrapper');
    imageWrappers.forEach(wrapper => {
        const img = wrapper.querySelector('.detail-image');
        if (img) {
            wrapper.addEventListener('click', function(event) {
                if (!event.target.closest('.delete-image-btn')) {
                    openModal(img.src);
                }
            });
        }
    });

    const closeBtn = document.querySelector('.close-modal');
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }

    const modal = document.getElementById('imageModal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                closeModal();
            }
        });
    }
});

function deleteImage(type) {
    if (confirm('Are you sure you want to delete this image?')) {
        document.getElementById('delete_' + type + '_image').value = 'true';

        const imageContainer = document.querySelector('.' + type + '-col .image-container');
        if (imageContainer) {
            imageContainer.style.display = 'none';
        }

        const message = document.createElement('div');
        message.className = 'delete-message';
        message.textContent = 'Image will be deleted when you save changes.';
        
        const col = document.querySelector('.' + type + '-col');
        if (col) {
            col.insertBefore(message, col.querySelector('label[for="' + type + '_image"]'));
        }
    }
}

function openModal(imageSrc) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');

    if (!modal || !modalImage) {
        console.error('Modal elements not found');
        return;
    }

    modalImage.src = imageSrc;
    modalImage.classList.remove('zoomed'); 
    modal.classList.add('show');
    document.body.classList.add('modal-open');

    modalImage.onclick = function(event) {
        event.stopPropagation();
        toggleZoom(modalImage);
    };
}

function toggleZoom(image) {
    if (image.classList.contains('zoomed')) {
        image.classList.remove('zoomed');
    } else {
        image.classList.add('zoomed');
    }
}

function closeModal() {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');

    if (modal) {
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
    }

    if (modalImage) {
        modalImage.classList.remove('zoomed'); 
        modalImage.onclick = null; 
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeModal();
    }
});

document.querySelectorAll('textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
    textarea.dispatchEvent(new Event('input'));
});


(function() {
    const modalImage = document.getElementById('modalImage');
    let isDragging = false;
    let startX, startY, originX = 50, originY = 50;

    function setTransformOrigin(x, y) {
        modalImage.style.setProperty('--zoom-x', `${x}%`);
        modalImage.style.setProperty('--zoom-y', `${y}%`);
    }

    modalImage.addEventListener('mousedown', function(e) {
        if (!modalImage.classList.contains('zoomed')) return;
        isDragging = true;
        modalImage.style.cursor = 'grabbing';
        startX = e.clientX;
        startY = e.clientY;
        e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        originX = Math.min(100, Math.max(0, originX - dx / 8));
        originY = Math.min(100, Math.max(0, originY - dy / 8));
        setTransformOrigin(originX, originY);
        startX = e.clientX;
        startY = e.clientY;
    });

    document.addEventListener('mouseup', function() {
        if (isDragging) {
            isDragging = false;
            modalImage.style.cursor = 'grab';
        }
    });

    function resetZoomOrigin() {
        originX = 50;
        originY = 50;
        setTransformOrigin(originX, originY);
        modalImage.style.cursor = 'zoom-in';
    }

    window.toggleZoom = function(image) {
        if (image.classList.contains('zoomed')) {
            image.classList.remove('zoomed');
            resetZoomOrigin();
        } else {
            image.classList.add('zoomed');
            resetZoomOrigin();
            modalImage.style.cursor = 'grab';
        }
    };

    window.closeModal = function() {
        const modal = document.getElementById('imageModal');
        if (modal) {
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        }
        if (modalImage) {
            modalImage.classList.remove('zoomed');
            resetZoomOrigin();
            modalImage.onclick = null;
        }
    };
})();
</script>
{% endblock %}
