{% extends "base.html" %}
{% block title %}Trades - STS{% endblock %}
{% block content %}
    <h1>Trades</h1>
    <hr class="title-divider">
    
    <div class="top-bar">
        <form method="get" action="{{ url_for('index') }}" class="search-filter-form">
            <select name="date_filter" id="date_filter" onchange="this.form.submit()">
                <option value="last30" {% if request.args.get('date_filter', 'last30') == 'last30' %}selected{% endif %}>Last 30</option>
                <option value="today" {% if request.args.get('date_filter', 'last30') == 'today' %}selected{% endif %}>Today</option>
                <option value="week" {% if request.args.get('date_filter', 'last30') == 'week' %}selected{% endif %}>This Week</option>
                <option value="month" {% if request.args.get('date_filter', 'last30') == 'month' %}selected{% endif %}>This Month</option>
                <option value="year" {% if request.args.get('date_filter', 'last30') == 'year' %}selected{% endif %}>This Year</option>
                <option value="all" {% if request.args.get('date_filter', 'last30') == 'all' %}selected{% endif %}>All Time</option>
            </select>
            <div class="search-bar">
                <input class="input-search" type="text" name="search" id="search-input" placeholder="Search trades..." value="{{ request.args.get('search', '') }}" onkeyup="if(event.keyCode===13) this.form.submit();">
                <i class="fas fa-search search-icon"></i>
            </div>

            <div class="monthly-rr-badge">
                <span class="label">Monthly R:R</span>
                <span class="value" style="color:{% if monthly_rr is not none and monthly_rr >= 0 %}#38CB89{% else %}#FD6E4E{% endif %};">
                    {{ "%.2f"|format(monthly_rr) if monthly_rr is not none else "0.00" }}
                </span>
            </div>
        </form>
    </div>
 
    <div class="table-section">
        <table id="trades-table" class="table table-striped display responsive nowrap" style="width:100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Ticker</th>
                    <th>Open Time</th>
                    <th>Close Time</th>
                    <th>Type</th>
                    <th>Status</th>
                    <th>Sort</th>
                    <th>Open Price</th>
                    <th>Close Price</th>
                    <th>Risk</th>
                    <th>Stop-Loss</th>
                    <th>Take-Profit</th>
                    <th>RR</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <tr id="add-row" style="display:none;">
                    <form action="{{ url_for('add_trade') }}" method="post">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <td>New</td>
                        <td><input name="symbol" required style="text-transform:uppercase;"></td>
                        <td><input type="datetime-local" name="open_time" required></td>
                        <td><input type="datetime-local" name="close_time"></td>
                        <td>
                            <select name="type" required>
                                <option value="HTF">HTF</option>
                                <option value="MTF">MTF</option>
                                <option value="LTF">LTF</option>
                            </select>
                        </td>
                        <td>
                            <select name="status" required>
                                <option value="OPEN">OPEN</option>
                                <option value="CLOSED">CLOSED</option>
                            </select>
                        </td>
                        <td>
                            <select name="sort" required>
                                <option value="LONG">LONG</option>
                                <option value="SHORT">SHORT</option>
                            </select>
                        </td>
                        <td><input name="open_price" type="number" step="any" required></td>
                        <td><input name="close_price" type="number" step="any"></td>
                        <td><input name="risk" type="number" step="any" required></td>
                        <td><input name="SL" type="number" step="any"></td>
                        <td><input name="TP" type="number" step="any"></td>
                        <td>Auto</td>
                        <td>
                            <button type="submit" class="save-btn">Save</button>
                            <button type="button" class="cancel-btn" onclick="hideAddRow()">Cancel</button>
                        </td>
                    </form>
                </tr>

                {% if trades %}
                    {% for user in trades %}
                        {% if not user.parent_id %}
                    <tr class="{% if user.RR is not none %}
                            {% if user.RR >= 0 %}winner
                            {% elif user.RR < 0 %}loser
                            {% else %}breakeven{% endif %}
                        {% else %}open-trade{% endif %}"
                        id="row-{{ user.id }}"
                        onclick="if (!this.classList.contains('editing')) window.location='{{ url_for('user_detail', user_id=user.id) }}';"
                        style="cursor:pointer;">
                        <td data-label="ID" style="text-align: center;">{{ user.id }}</td>
                        <td data-label="Ticker" class="editable" data-field="symbol">{{ user.symbol }}</td>
                        <td data-label="Open Time" class="editable" data-field="open_time">
                            {% if user.open_time %}
                                {{ user.open_time.split('T')[0] if 'T' in user.open_time else user.open_time.split(' ')[0] }}<br>
                                <span style="font-size: 0.7em; color: #888;">
                                    {{ user.open_time.split('T')[1] if 'T' in user.open_time else user.open_time.split(' ')[1] }}
                                </span>
                            {% endif %}
                        </td>
                        <td data-label="Close Time" class="editable" data-field="close_time">
                            {% if user.close_time %}
                                {{ user.close_time.split('T')[0] if 'T' in user.close_time else user.close_time.split(' ')[0] }}<br>
                                <span style="font-size: 0.7em; color: #888;">
                                    {{ user.close_time.split('T')[1] if 'T' in user.close_time else user.close_time.split(' ')[1] }}
                                </span>
                            {% endif %}
                        </td>
                        <td data-label="Type" class="editable" data-field="type">{{ user.type }}</td>
                        <td data-label="Status" class="editable" data-field="status">{{ user.status }}</td>
                        <td data-label="Sort">
                            <span class="direction-pill {{ 'long' if user.sort == 'LONG' else 'short' }}">{{ user.sort }}</span>
                        </td>
                        <td data-label="Open Price" class="editable" data-field="open_price">{% if user.open_price %}${{ user.open_price|smart_price }}{% endif %}</td>
                        <td data-label="Close Price" class="editable" data-field="close_price">{% if user.close_price %}${{ user.close_price|smart_price }}{% endif %}</td>
                        <td data-label="Risk" class="editable" data-field="risk">{{ user.risk|smart_price }}</td>
                        <td data-label="Stop-Loss" class="editable" data-field="SL">{% if user.SL %}${{ user.SL|smart_price }}{% endif %}</td>
                        <td data-label="Take-Profit" class="editable" data-field="TP">{% if user.TP %}${{ user.TP|smart_price }}{% endif %}</td>
                        <td data-label="RR" class="{% if user.RR is none %}neutral_R{% elif user.RR >= 0 %}positive_R{% else %}negative_R{% endif %}">
                            {% if user.RR is not none %}
                                {{ "%.2f"|format(user.RR) }}
                            {% else %}
                                <span style="color:#888;">â€”</span>
                            {% endif %}
                        </td>
                        <td class="action-cell" onclick="event.stopPropagation();">
                            <div class="action-btns">
                                <button class="edit-btn" onclick="event.stopPropagation(); editRow({{ user.id }})"><i class="fa fa-edit"></i></button>
                                <form action="{{ url_for('delete_trade', user_id=user.id) }}" method="post" style="display:inline;">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                    <button class="delete-btn" type="submit" onclick="return confirm('Delete?');"><i class="fa fa-trash"></i></button>
                                </form>
                                {% if user.status == 'OPEN' %}
                                <button class="partial-btn" onclick="event.stopPropagation(); togglePartialForm({{ user.id }})">Add</button>
                                {% endif %}
                            </div>
                        </td>
                    </tr>

                    <tr id="partial-form-row-{{ user.id }}" class="partial-form-row" style="display:none; background:#f8f9fa;">
                    </tr>
                    {% for partial in partials_by_parent.get(user.id|int, []) %}

                    {% endfor %}
                        {% endif %}
                    {% endfor %}

                    {# === ORPHANED PARTIALS â€” FIXED FOR FLASK (no 'do' tag) === #}
                    {% set parent_ids = namespace(value=[]) %}
                    {% for t in trades %}
                        {% if not t.parent_id %}
                            {% set _ = parent_ids.value.append(t.id) %}
                        {% endif %}
                    {% endfor %}

                    {% set orphaned_partials = namespace(value=[]) %}
                    {% for trade in trades %}
                        {% if trade.parent_id and trade.parent_id not in parent_ids.value %}
                            {% set _ = orphaned_partials.value.append(trade) %}
                        {% endif %}
                    {% endfor %}

                    {% if orphaned_partials.value %}
                    <tr style="background:#fff3cd;">
                        <td colspan="14" style="text-align:center;font-weight:bold;padding:10px;">
                            Orphaned Partial Trades (Missing Parent)
                        </td>
                    </tr>
                    {% for p in orphaned_partials.value %}
                    <tr class="partial-close-row orphaned" style="background:#fff3cd;">
                        <td style="color:orange;">Warning {{ p.id }}</td>
                        <td colspan="13" style="color:orange;">
                            Missing parent ID: {{ p.parent_id }} â€” {{ p.symbol }}
                        </td>
                    </tr>
                    {% endfor %}
                    {% endif %}

                {% else %}
                    <tr>
                        <td colspan="14" style="text-align:center;padding:60px;color:#888;">
                            <svg width="80" height="80" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity:0.3;margin-bottom:20px;">
                                <circle cx="60" cy="60" r="50" stroke="currentColor" stroke-width="3" stroke-dasharray="8 8"/>
                                <path d="M40 60L55 75L80 45" stroke="currentColor" stroke-width="4"/>
                            </svg>
                            <h4>No trades yet</h4>
                            <p>Click the green + button to add your first trade!</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
{% endblock %}

{% block floating_button %}
    <button id="show-add-row" class="add-btn fab" title="Add Trade">+Add Trade</button>
{% endblock %}

{% block extra_scripts %}
<!-- DataTables CSS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css">

<!-- DataTables JS -->
<script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script defer src="{{ url_for('static', filename='edit.js') }}"></script>

<script>
$(document).ready(function() {
    setTimeout(function() {
        $('#trades-table').DataTable({
            responsive: true,
            pageLength: 50,
            lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
            order: [[2, 'desc']],
            columnDefs: [{ orderable: false, targets: [13] }, { orderable: false, targets: [0] }],
            dom: 'lfrtip',
            language: { search: "", searchPlaceholder: "Quick search..." },
            selector: { rows: 'tbody tr:not(#add-row):not(.partial-form-row):not(.editing)', cells: 'td:not(.action-cell)' }
        });
    }, 100);
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const body = document.body;
    const themeToggles = document.querySelectorAll('.theme-toggle-btn');
    const themeForm = document.getElementById('theme-toggle-form');
    let isDark = body.classList.contains('dark-theme');

    function updateThemeIcons() {
        document.querySelectorAll('.theme-icon').forEach(icon => {
            icon.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
        });
    }

    themeToggles.forEach((btn, index) => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            body.classList.toggle('dark-theme');
            isDark = body.classList.contains('dark-theme');
            updateThemeIcons();
            
            setTimeout(() => themeForm.submit(), 50);
        }, true);
    });

    updateThemeIcons();
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const addRow = document.getElementById('add-row');
    const fab = document.getElementById('show-add-row');

    window.showAddRow = function () {
        addRow.style.display = 'table-row';
        addRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
        setTimeout(() => addRow.querySelector('input[name="symbol"]')?.focus(), 100);
        fab.style.display = 'none';
    };

    window.hideAddRow = function () {
        addRow.style.display = 'none';
        fab.style.display = 'flex';
    };

    const newFab = fab.cloneNode(true);
    fab.parentNode.replaceChild(newFab, fab);
    
    newFab.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();
        console.log('FAB clicked!');
        showAddRow();
    }, true);

    document.addEventListener('keydown', e => {
        if (e.key === '+' && !e.ctrlKey && !e.shiftKey && !e.altKey &&
            !['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName)) {
            e.preventDefault();
            e.stopPropagation();
            newFab.click();
        }
    });
});
</script>

<style>
.add-btn.fab, .theme-toggle-btn { z-index: 999999 !important; pointer-events: auto !important; }
#add-row, #show-add-row { pointer-events: auto !important; }
body.dark-theme .dataTables_wrapper { color: #e0e0e0; }
body.dark-theme .dataTables_wrapper .dataTables_length label,
body.dark-theme .dataTables_wrapper .dataTables_filter input { color: #e0e0e0; }
</style>
{% endblock %}
